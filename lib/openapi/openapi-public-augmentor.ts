#!/usr/bin/env ts-node
/* eslint-disable @typescript-eslint/no-explicit-any */

/**
 * This script injects AWS API Gateway specific settings into our public openapi and output to dist/openapi/openapi-public-autogenerated.yaml
 */

import * as fs from 'fs'
import * as yaml from 'js-yaml'
import _ from 'lodash'
import mkdirp from 'mkdirp'
import { StackConstants } from '../constants'
import { getAugmentedOpenapi } from './openapi-augmentor-util'

// We don't care about region
const env = (process.env.ENV || 'prod').split(':')[0]

const PathToLambda: any = {
  '/transactions': StackConstants.PUBLIC_API_TRANSACTION_FUNCTION_NAME,
  '/transactions/{transactionId}':
    StackConstants.PUBLIC_API_TRANSACTION_FUNCTION_NAME,
  '/consumer/users': StackConstants.PUBLIC_API_USER_FUNCTION_NAME,
  '/consumer/users/{userId}': StackConstants.PUBLIC_API_USER_FUNCTION_NAME,
  '/business/users': StackConstants.PUBLIC_API_USER_FUNCTION_NAME,
  '/business/users/{userId}': StackConstants.PUBLIC_API_USER_FUNCTION_NAME,
  '/events/transaction/{eventId}': StackConstants.PUBLIC_API_USER_FUNCTION_NAME,
  '/events/transaction':
    StackConstants.PUBLIC_API_TRANSACTION_EVENT_FUNCTION_NAME,
  '/events/consumer/user': StackConstants.PUBLIC_API_USER_EVENT_FUNCTION_NAME,
  '/events/business/user': StackConstants.PUBLIC_API_USER_EVENT_FUNCTION_NAME,
}

const openapi = getAugmentedOpenapi(
  './lib/openapi/public/openapi-public-original.yaml',
  PathToLambda,
  'API_KEY'
)
mkdirp.sync(`./dist/openapi`)
fs.writeFileSync(
  `./dist/openapi/openapi-public-autogenerated-${env}.yaml`,
  yaml.dump(openapi)
)
