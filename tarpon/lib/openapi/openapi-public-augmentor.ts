#!/usr/bin/env ts-node
/* eslint-disable @typescript-eslint/no-explicit-any */

/**
 * This script injects AWS API Gateway specific settings into our public openapi and output to dist/openapi/openapi-public-autogenerated.yaml
 */

import * as fs from 'fs'
import * as yaml from 'js-yaml'
import mkdirp from 'mkdirp'
import { StackConstants } from '../constants'
import { getAugmentedOpenapi } from './openapi-augmentor-util'

// We don't care about region
const env = (process.env.ENV || 'prod').split(':')[0]

export const PublicApiPathToLambda: any = {
  '/transactions': StackConstants.PUBLIC_API_TRANSACTION_FUNCTION_NAME,
  '/transactions/{transactionId}':
    StackConstants.PUBLIC_API_TRANSACTION_FUNCTION_NAME,
  '/consumer/users': StackConstants.PUBLIC_API_USER_FUNCTION_NAME,
  '/consumer/users/{userId}': StackConstants.PUBLIC_API_USER_FUNCTION_NAME,
  '/business/users': StackConstants.PUBLIC_API_USER_FUNCTION_NAME,
  '/business/users/{userId}': StackConstants.PUBLIC_API_USER_FUNCTION_NAME,
  '/events/transaction/{eventId}':
    StackConstants.PUBLIC_API_TRANSACTION_EVENT_FUNCTION_NAME,
  '/events/transaction':
    StackConstants.PUBLIC_API_TRANSACTION_EVENT_FUNCTION_NAME,
  '/events/consumer/user': StackConstants.PUBLIC_API_USER_EVENT_FUNCTION_NAME,
  '/events/consumer/user/{eventId}':
    StackConstants.PUBLIC_API_USER_EVENT_FUNCTION_NAME,
  '/events/business/user': StackConstants.PUBLIC_API_USER_EVENT_FUNCTION_NAME,
  '/events/business/user/{eventId}':
    StackConstants.PUBLIC_API_USER_EVENT_FUNCTION_NAME,
  '/batch/transactions': StackConstants.PUBLIC_API_TRANSACTION_FUNCTION_NAME,
  '/batch/events/transaction':
    StackConstants.PUBLIC_API_TRANSACTION_EVENT_FUNCTION_NAME,
  '/batch/consumer/users': StackConstants.PUBLIC_API_USER_FUNCTION_NAME,
  '/batch/events/consumer/user':
    StackConstants.PUBLIC_API_USER_EVENT_FUNCTION_NAME,
  '/batch/business/users': StackConstants.PUBLIC_API_USER_FUNCTION_NAME,
  '/batch/events/business/user':
    StackConstants.PUBLIC_API_USER_EVENT_FUNCTION_NAME,
}

const openapi = getAugmentedOpenapi(
  './dist/openapi/public/openapi-public-original.yaml',
  PublicApiPathToLambda,
  'API_KEY'
)
mkdirp.sync(`./dist/openapi`)
fs.writeFileSync(
  `./dist/openapi/openapi-public-autogenerated-${env}.yaml`,
  yaml.dump(openapi)
)
